<style>
  .export-import-grid {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: 1fr;
    gap: 1rem;
    background-color: rgb(241, 241, 241);
    border-radius: 6px;
    padding: 0px 12px 6px 12px;
  }

  button {
    font-family: Inter;
    background-color: rgb(13, 153, 255);
    color: white;
    border: rgb(13, 153, 255);
    border-radius: 6px;
    padding: 8.5px 12px;
  }

  select {
    font-family: Inter;
    background-color: white;
    color: black;
    border-radius: 6px;
    padding: 6px 0px;
  }

  .do {
    color: green;
    background-color: #ddfcdd;
    font-size: 0.9rem;
    border-radius: 6px;
    padding: 0.5rem;
  }

  .dont {
    color: red;
    background-color: #ffe0e0;
    font-size: 0.9rem;
    margin-right: 0.25rem;
    border-radius: 6px;
    padding: 0.5rem;
  }
</style>

<body style="padding: 1.5rem; margin: 0px; font-family: Inter;">
  <h2 style="margin-bottom: 0.5rem; text-align: center;">Variables ‚áî CSV</h2>
  <p style="margin-top: 0px; margin-bottom: 2rem;">üëâ Export to CSV and bulk edit Figma variables
    (only values)
    <br />
    üëâ Import the edited CSV and sync values back to Figma
    <br />
    üëâ Multi-lingual support built-in. See <a href="https://www.figma.com/community/plugin/1355357264377995556"
      target="_blank">instructions</a> for MS Excel.
  </p>
  <div class="export-import-grid">
    <div>
      <h3>Export collection to CSV</h3>
      <div style="margin-top: 0.5rem;">
        <select id="dropdown" style="font-family: Inter;">
        </select>
        <button id="export">Export</button>
      </div>
    </div>
    <div>
      <h3>Import collection from CSV</h3>
      <div>
        <input type="file" id="csvFileInput" accept=".csv" style="font-family: Inter; width: 100%; margin: 0px;">
      </div>
      <p style="color: slategray; font-size: 0.65rem;">CSV should be in the format shown below</p>
    </div>
  </div>
  <p style="color: slategray; font-size: 0.75rem;">Only string variables can be exported and
    imported,
    for data sanity
    reasons
  </p>
  <div style="margin-bottom: 2rem; text-align: center;">
    <h4 style="margin-bottom: 0.25rem;">CSV format</h4>
    <div>
      <svg width="320" height="120" viewBox="0 0 320 120" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g filter="url(#filter0_d_41_187)">
          <path d="M5.99945 0.3H127.7V29.5H0.3V5.99946C0.3 2.85174 2.85173 0.3 5.99945 0.3Z" fill="white"
            fill-opacity="0.5" />
          <path d="M5.99945 0.3H127.7V29.5H0.3V5.99946C0.3 2.85174 2.85173 0.3 5.99945 0.3Z" stroke="#008000"
            stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            font-weight="bold" letter-spacing="0em">
            <tspan x="6" y="20.1363">Collection name</tspan>
          </text>
          <rect x="128.3" y="0.3" width="63.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="128.3" y="0.3" width="63.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            font-weight="bold" letter-spacing="0em">
            <tspan x="133" y="20.1363">Mode A</tspan>
          </text>
          <rect x="192.3" y="0.3" width="63.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="192.3" y="0.3" width="63.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            font-weight="bold" letter-spacing="0em">
            <tspan x="197.5" y="20.1363">Mode B</tspan>
          </text>
          <path d="M256.3 0.3H314.001C317.148 0.3 319.7 2.85173 319.7 5.99945V29.5H256.3V0.3Z" fill="white"
            fill-opacity="0.5" />
          <path d="M256.3 0.3H314.001C317.148 0.3 319.7 2.85173 319.7 5.99945V29.5H256.3V0.3Z" stroke="#008000"
            stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            font-weight="bold" letter-spacing="0em">
            <tspan x="281.5" y="20.1363">...</tspan>
          </text>
          <rect x="0.3" y="30.1" width="127.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="0.3" y="30.1" width="127.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="30.5" y="49.9363">variable-1</tspan>
          </text>
          <rect x="128.3" y="30.1" width="63.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="128.3" y="30.1" width="63.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="135" y="49.9363">value A</tspan>
          </text>
          <rect x="192.3" y="30.1" width="63.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="192.3" y="30.1" width="63.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="199" y="49.9363">value B</tspan>
          </text>
          <rect x="256.3" y="30.1" width="63.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="256.3" y="30.1" width="63.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="282" y="49.9363">...</tspan>
          </text>
          <rect x="0.3" y="59.9001" width="127.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="0.3" y="59.9001" width="127.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="29.5" y="79.7364">variable-2</tspan>
          </text>
          <rect x="128.3" y="59.9001" width="63.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="128.3" y="59.9001" width="63.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="135" y="79.7364">value A</tspan>
          </text>
          <rect x="192.3" y="59.9001" width="63.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="192.3" y="59.9001" width="63.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="199" y="79.7364">value B</tspan>
          </text>
          <rect x="256.3" y="59.9001" width="63.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="256.3" y="59.9001" width="63.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="282" y="79.7364">...</tspan>
          </text>
          <path d="M0.3 89.6999H127.7V118.9H5.99945C2.85173 118.9 0.3 116.348 0.3 113.2V89.6999Z" fill="white"
            fill-opacity="0.5" />
          <path d="M0.3 89.6999H127.7V118.9H5.99945C2.85173 118.9 0.3 116.348 0.3 113.2V89.6999Z" stroke="#008000"
            stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="58" y="109.536">...</tspan>
          </text>
          <rect x="128.3" y="89.6999" width="63.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="128.3" y="89.6999" width="63.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="154" y="109.536">...</tspan>
          </text>
          <rect x="192.3" y="89.6999" width="63.4" height="29.2" fill="white" fill-opacity="0.5" />
          <rect x="192.3" y="89.6999" width="63.4" height="29.2" stroke="#008000" stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="218" y="109.536">...</tspan>
          </text>
          <path d="M256.3 89.6999H319.7V113.2C319.7 116.348 317.148 118.9 314.001 118.9H256.3V89.6999Z" fill="white"
            fill-opacity="0.5" />
          <path d="M256.3 89.6999H319.7V113.2C319.7 116.348 317.148 118.9 314.001 118.9H256.3V89.6999Z" stroke="#008000"
            stroke-width="0.6" />
          <text fill="black" xml:space="preserve" style="white-space: pre" font-family="Inter" font-size="14.4"
            letter-spacing="0em">
            <tspan x="282" y="109.536">...</tspan>
          </text>
        </g>
        <defs>
          <filter id="filter0_d_41_187" x="-10.499" y="-8.99918" width="340.998" height="140.198"
            filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
            <feFlood flood-opacity="0" result="BackgroundImageFix" />
            <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
              result="hardAlpha" />
            <feOffset dy="1.49986" />
            <feGaussianBlur stdDeviation="5.24952" />
            <feComposite in2="hardAlpha" operator="out" />
            <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0" />
            <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_41_187" />
            <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_41_187" result="shape" />
          </filter>
        </defs>
      </svg>
    </div>
  </div>

  <div style="display: grid; grid-auto-flow: column; grid-auto-columns: 1fr; gap: 1rem;">
    <div class="do">
      <h4 style="margin-bottom: 0.5rem; text-align: center;">Do ‚úÖ</h4>
      <ul style="margin-top: 0px; padding-inline-start: 1rem;">
        <li>Create variables only on Figma</li>
        <li>Edit variables names only on Figma</li>
        <li>Treat Figma as the source of truth for variables</li>
      </ul>
    </div>
    <div class="dont">
      <h4 style="margin-bottom: 0.5rem; text-align: center;">Don't ‚ùå</h4>
      <ul style="margin-top: 0px; padding-inline-start: 1.5rem;">
        <li>Do not edit column headers on the CSV</li>
        <li>Do not edit collection name/variable name on Figma, in the middle of
          export/import cycle.
        </li>
      </ul>
    </div>
  </div>


  <div style="color: slategray; font-size: 0.75rem; text-align: center;">
    <p>Another project by <a href="https://www.figma.com/@vivek_nexus" target="_blank">Vivek</a> | CSV parser via <a
        href="https://github.com/vanillaes/csv" target="_blank">Vanillaes CSV</a> package
    </p>
    <p></p>
  </div>

</body>


<script>
  let chosenCollection = {
    name: "",
    id: ""
  }
  parent.postMessage({ pluginMessage: { type: "get-collections" } }, '*')

  window.addEventListener("message", (event) => {
    // consume collections
    if (event.data.pluginMessage.type === "get-collections") {
      const collections = event.data.pluginMessage.body

      if (CheckDuplicateCollections(collections)) {
        alert("Some collections have the same name. Please rename them and re-run the plugin.")
      }

      PopulateDropdown(collections)

      const dropdown = document.querySelector("#dropdown")

      dropdown.addEventListener("change", function (event) {
        const selectedOption = dropdown.options[dropdown.selectedIndex];
        chosenCollection = {
          name: selectedOption.getAttribute("data-name"),
          id: selectedOption.value
        }
      });
    }

    // consume CSV to export
    if (event.data.pluginMessage.type === "export") {
      const filename = event.data.pluginMessage.body.collection.name
      const csvData = event.data.pluginMessage.body.csvData
      DownloadCSV(csvData, filename)
    }
  })

  // request data to export
  document.querySelector("#export").addEventListener("click", () => {
    console.log(chosenCollection)
    parent.postMessage({ pluginMessage: { type: "export", collection: chosenCollection } }, '*')
  })

  // Add event listener to file input
  document.querySelector("#csvFileInput").addEventListener("change", (event) => {
    ReadCSV(event).then((importedCSV) => {
      parent.postMessage({
        pluginMessage: {
          type: "import",
          importedCSV: importedCSV
        }
      }, '*')
    })
  });

  // FUNCTIONS
  // Function to download csv string as csv file 
  function DownloadCSV(csvData, filename) {
    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' })

    const link = document.createElement('a')
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob)
      link.setAttribute('href', url)
      link.setAttribute('download', filename)
      link.style.visibility = 'hidden'
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
    }
  }

  // Function to handle file upload and return parsed CSV data
  function ReadCSV(event, collection) {
    const input = event.target
    const file = input.files?.[0]

    if (file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader()
        reader.onload = function () {
          const csvData = reader.result
          resolve(csvData)
        }
        reader.onerror = function (error) {
          reject(error)
        }
        reader.readAsText(file)
      })
    }
    return null
  }

  // Function to populate the dropdown with options
  function PopulateDropdown(collections) {
    const dropdown = document.getElementById("dropdown");

    // Clear existing options
    dropdown.innerHTML = '';

    // Add options from the array
    collections.forEach((item) => {
      const option = document.createElement("option");
      option.setAttribute("data-name", item.name);
      option.value = item.id;
      option.text = item.name;
      dropdown.appendChild(option);
    });

    chosenCollection = {
      name: collections[0].name,
      id: collections[0].id
    }
  }

  function CheckDuplicateCollections(collections) {
    const collectionNames = []
    for (const collection of collections) {
      collectionNames.push(collection.name)
    }

    return (collectionNames.length !== (new Set(collectionNames)).size)
  }
</script>