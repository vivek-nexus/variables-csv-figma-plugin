<style>
  .export-import-grid {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: 1fr;
    gap: 1rem;
    background-color: rgb(241, 241, 241);
    border-radius: 6px;
    padding: 0px 12px 6px 12px;
  }

  button {
    font-family: Inter;
    background-color: rgb(13, 153, 255);
    color: white;
    border: rgb(13, 153, 255);
    border-radius: 6px;
    padding: 8px 12px;
  }

  select {
    font-family: Inter;
    background-color: white;
    color: black;
    border-radius: 6px;
    padding: 6px 0px;
  }

  .do {
    color: green;
    background-color: rgb(221, 252, 221);
    font-size: 0.9rem;
    /* margin-right: 1rem; */
    border-radius: 6px;
    padding: 0.5rem;
  }

  .dont {
    color: red;
    background-color: rgb(255, 224, 224);
    font-size: 0.9rem;
    margin-right: 0.25rem;
    border-radius: 6px;
    padding: 0.5rem;
  }
</style>

<body style="padding: 1.5rem; margin: 0px; font-family: Inter;">
  <h2 style="margin-bottom: 0.5rem; text-align: center;">Variables ⇔ CSV</h2>
  <p style="margin-top: 0px; text-align: center; margin-bottom: 2rem;">Export and bulk edit variables values on a CSV
    <br />
    Import the CSV and sync values back to Figma
  </p>
  <div class="export-import-grid">
    <div>
      <h3>Export collection to CSV</h3>
      <!-- <label for="dropdown">Select collection to export</label> -->
      <div style="margin-top: 0.5rem;">
        <select id="dropdown" style="font-family: Inter;">
        </select>
        <button id="export">Export</button>
      </div>
    </div>
    <div>
      <h3>Import collection from CSV</h3>
      <div>
        <input type="file" id="csvFileInput" accept=".csv" style="font-family: Inter; width: 100%; margin: 0px;">
      </div>
      <p style="color: slategray; font-size: 0.65rem;">Upload CSV generated from this plugin only please</p>
    </div>
  </div>
  <p style="text-align: center; color: slategray; font-size: 0.75rem;">Only string variables can be exported and
    imported,
    for data sanity
    reasons</p>
  <div style="display: grid; grid-auto-flow: column; grid-auto-columns: 1fr; gap: 1rem;">
    <div class="do">
      <h4 style="margin-bottom: 0.5rem; text-align: center;">Do ✅</h4>
      <ul style="margin-top: 0px; padding-inline-start: 1rem;">
        <li>Create variables only on Figma</li>
        <li>Edit variables names only on Figma</li>
        <li>Edit variable values preferably on the CSV</li>
        <li>Export a fresh CSV at the beginning of each export/import cycle</li>
        <li>Treat Figma as the source of truth for variables</li>
      </ul>
    </div>
    <div class="dont">
      <h4 style="margin-bottom: 0.5rem; text-align: center;">Don't ❌</h4>
      <ul style="margin-top: 0px; padding-inline-start: 1.5rem;">
        <li>Do not edit column headers on the CSV</li>
        <li>Do not edit collection name/variable name on Figma, in the middle of
          export/import cycle.
        </li>
        <li>Do not add/delete varaibles on Figma, in the middle of
          export/import cycle.
        </li>
        </li>
      </ul>
    </div>
  </div>


  <div style="color: slategray; font-size: 0.75rem; text-align: center;">
    <p>Another project by <a href="https://www.figma.com/@vivek_nexus" target="_blank">Vivek</a> | CSV parser via <a
        href="https://github.com/vanillaes/csv" target="_blank">Vanillaes CSV</a> package
    </p>
    <p></p>
  </div>

</body>


<script>
  let chosenCollection = ""
  parent.postMessage({ pluginMessage: { type: "get-collections" } }, '*')

  window.addEventListener("message", (event) => {
    if (event.data.pluginMessage.type === "get-collections") {
      const collections = event.data.pluginMessage.body

      PopulateDropdown(collections)

      document.querySelector("#dropdown").addEventListener("change", function (event) {
        const selectedValue = this.value
        chosenCollection = selectedValue
      });
    }

    if (event.data.pluginMessage.type === "export") {
      const collection = event.data.pluginMessage.body.collection
      const csvData = event.data.pluginMessage.body.csvData
      DownloadCSV(csvData, collection)
    }
  })

  document.querySelector("#export").addEventListener("click", () => {
    parent.postMessage({ pluginMessage: { type: "export", collection: chosenCollection } }, '*')
  })

  // Add event listener to file input
  document.querySelector("#csvFileInput").addEventListener("change", (event) => {
    ReadCSV(event).then((importedCSV) => {
      parent.postMessage({
        pluginMessage: {
          type: "import",
          importedCSV: importedCSV
        }
      }, '*')
    })
  });

  function DownloadCSV(csvData, filename) {
    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' })

    const link = document.createElement('a')
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob)
      link.setAttribute('href', url)
      link.setAttribute('download', filename)
      link.style.visibility = 'hidden'
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
    }
  }

  // Function to handle file upload and return parsed CSV data
  function ReadCSV(event, collection) {
    const input = event.target
    const file = input.files?.[0]

    if (file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader()
        reader.onload = function () {
          const csvData = reader.result
          resolve(csvData)
        }
        reader.onerror = function (error) {
          reject(error)
        }
        reader.readAsText(file)
      })
    }
    return null
  }

  // Function to populate the dropdown with options
  function PopulateDropdown(collections) {
    const dropdown = document.getElementById("dropdown");

    // Clear existing options
    dropdown.innerHTML = '';

    // Add options from the array
    collections.forEach((item) => {
      const option = document.createElement("option");
      option.text = item;
      option.value = item;
      dropdown.appendChild(option);
    });

    chosenCollection = dropdown.value
  }



</script>