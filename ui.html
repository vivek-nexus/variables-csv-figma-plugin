<body style="padding: 1.5rem; margin: 0px; font-family: Ubuntu;">
  <h2 style="margin-bottom: 0.5rem; text-align: center;">Variables â‡” CSV</h2>
  <p style="margin-top: 0px; text-align: center; font-weight: bold;">Export variables to CSV, bulk edit variables values
    and sync
    them back to Figma</p>
  <div style="display: grid; grid-auto-flow: column; grid-auto-columns: 1fr;">
    <div style="color: green; font-size: 0.9rem; margin-right: 0.25rem;">
      <h4 style="margin-bottom: 0.5rem; text-align: center;">Do</h4>
      <ul style="margin-top: 0px; padding-inline-start: 1rem;">
        <li>Create variables only on Figma</li>
        <li>Edit variables names only on Figma</li>
        <li>Edit variable values preferably on the CSV</li>
        <li>Delete/overwrite the previously exported CSV after importing it back, or at least before exporting the next
          CSV</li>
      </ul>
    </div>
    <div style="border-left: 2px solid rgb(210, 210, 210); color: red; font-size: 0.9rem;">
      <h4 style="margin-bottom: 0.5rem; text-align: center;">Don't</h4>
      <ul style="margin-top: 0px; padding-inline-start: 1.5rem;">
        <li>Do not edit column headers on the CSV</li>
        <li>Do not edit collection name/variable name on Figma, add/delete varaibles on Figma, in the middle of
          export/import cycle.
        </li>
        <li>Do not provide string values to number or boolean type variables in the CSV.
        </li>
      </ul>
    </div>
  </div>
  <p style="text-align: center; color: slategray; font-size: 0.9rem;">Color variables cannot be exported and imported,
    for data sanity
    reasons</p>
  <hr />
  <div style="display: grid; grid-auto-flow: column; grid-auto-columns: 1fr; gap:1rem;">
    <div>
      <h3>Export to CSV</h3>
      <label for="dropdown">Select collection to export</label>
      <div style="margin-top: 0.5rem;">
        <select id="dropdown" style="font-family: Ubuntu;">
        </select>
        <button id="export" style="font-family: Ubuntu;">Export</button>
      </div>
    </div>
    <div>
      <h3>Import from CSV</h3>
      <div style="margin-bottom: 3rem;">
        <input type="file" id="csvFileInput" accept=".csv" style="font-family: Ubuntu;">
      </div>
    </div>
  </div>
  <p style="color: slategray; font-size: 0.75rem; text-align: center;">Another project by <a
      href="https://vivek-nexus.github.io" target="_blank">Vivek</a>
  </p>

</body>


<script>
  let chosenCollection = ""
  parent.postMessage({ pluginMessage: { type: "get-collections" } }, '*')

  window.addEventListener("message", (event) => {
    if (event.data.pluginMessage.type === "get-collections") {
      const collections = event.data.pluginMessage.body

      PopulateDropdown(collections)

      document.querySelector("#dropdown").addEventListener("change", function (event) {
        const selectedValue = this.value
        chosenCollection = selectedValue
      });
    }

    if (event.data.pluginMessage.type === "export") {
      const collection = event.data.pluginMessage.body.collection
      const csvData = event.data.pluginMessage.body.csvData
      DownloadCSV(csvData, collection)
    }
  })

  document.querySelector("#export").addEventListener("click", () => {
    parent.postMessage({ pluginMessage: { type: "export", collection: chosenCollection } }, '*')
  })

  // Add event listener to file input
  document.querySelector("#csvFileInput").addEventListener("change", (event) => {
    ReadCSV(event).then((importedCSV) => {
      parent.postMessage({
        pluginMessage: {
          type: "import",
          importedCSV: importedCSV
        }
      }, '*')
    })
  });

  function DownloadCSV(csvData, filename) {
    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' })

    const link = document.createElement('a')
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob)
      link.setAttribute('href', url)
      link.setAttribute('download', filename)
      link.style.visibility = 'hidden'
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
    }
  }

  // Function to handle file upload and return parsed CSV data
  function ReadCSV(event, collection) {
    const input = event.target
    const file = input.files?.[0]

    if (file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader()
        reader.onload = function () {
          const csvData = reader.result
          resolve(csvData)
        }
        reader.onerror = function (error) {
          reject(error)
        }
        reader.readAsText(file)
      })
    }
    return null
  }

  // Function to populate the dropdown with options
  function PopulateDropdown(collections) {
    const dropdown = document.getElementById("dropdown");

    // Clear existing options
    dropdown.innerHTML = '';

    // Add options from the array
    collections.forEach((item) => {
      const option = document.createElement("option");
      option.text = item;
      option.value = item;
      dropdown.appendChild(option);
    });

    chosenCollection = dropdown.value
  }



</script>